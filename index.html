<html>
	<head>
		<link rel="stylesheet" type="text/css" href="styles.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
		<link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
	</head>
	<body>
	  <div class="row">
		  <div class="col-md-3" id="user-input">

		  	<div class="user-header">
		  		<div class="title">MOSC</div>
		  		<div class="description">Multiplexing Oversubscribed Circuits</div>
		  	</div>

		  	<form>
					The control panel below will let you make calls, send messages or look up websites through the cell tower access point that we built.
				</form>

		  	<form action="https://moscbackend.nicholas-fong.com/api/v1/emergency_call">
		  		<b>Make emergency call:</b><br>
		  		<input type="text" name="number" class="input-field" placeholder="Number"><br>
			    <input type="submit" value="Submit" class="submit">
			  </form>

			  <form action="https://moscbackend.nicholas-fong.com/api/v1/call">
		  		<b>Make non-emergency call:</b><br>
		  		<input type="text" name="number" class="input-field" placeholder="Number"><br>
			    <input type="submit" value="Submit" class="submit">
			  </form>

			  <form action="https://moscbackend.nicholas-fong.com/api/v1/sms">
		  		<b>Send SMS:</b><br>
		  		<input type="text" name="number" class="input-field" placeholder="Number"><br>
		  		<input type="text" name="message" class="input-field" placeholder="Message"><br>
			    <input type="submit" value="Submit" class="submit">
			  </form>

		  	<form action="https://moscbackend.nicholas-fong.com/api/v1/http">
			    <b>Visit website:</b><br>
			    <input type="text" name="url" class="input-field" placeholder="Website Url"><br>
			    <input type="submit" value="Submit" class="submit">
				</form>
		  </div>
		  <div class="col-md-9 analytics">

		  	<div class="analytics-header">
		  		Analytics Dashboard
		  	</div>
		  	
		  	<div class="analytics-data">
		  		<ul>
			  		<li>
			  			<h4>Emergency calls</h4>
			  			<div class="chart ecall-chart"></div>
			  		</li>
						<li>
							<h4>Regular calls</h4>
							<div class="chart call-chart"></div>
						</li>
						<li>
							<h4>Text messages</h4>
							<div class="chart sms-chart"></div>
						</li>
						<li>
							<h4>Web searches</h4>
							<div class="chart web-chart"></div>
						</li>
					</ul>

					<hr>

					<div class="explanation">
						<h3>So what is really happening?</h3>
						<div>
							As you know, everything from your phone, whether it's calls, text messages, or data all go through cell towers. During disasters, cell towers get overwhelmed with traffic and go down. What we're doing is making sure that the important stuff can go through in times of emergency by dropping less essential traffic and preventing cell towers from being overloaded.
						</div>
						<div>
							What you see on this page is our modest demo. The control panel on the left lets you send traffic towards a cell tower that we built remotely. The graphs above show what kind of data we received, and how many we actually serve. The calls/texts/etc. that aren't served are dropped so our cell tower doesn't get overwhelmed.
						</div>
					</div>
		  	</div>
		  </div>
		</div>
	</body>

	<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script>

		var ecall_data = [0, 0]; // [received, served]
		var call_data = [0, 0];
		var sms_data = [0, 0];
		var web_data = [0, 0];
		var labels = ["# Received", "# Served"];
		var i = 0;

		d3.selectAll(".chart")
		  .selectAll("div")
		    .data(ecall_data)
		  .enter()
		  	.append("span")
		  		.text(function(d) {
		  			if (i == 0) {
		  				return labels[i++];
		  			}
		  			return labels[i--]; 
		  		})
		  	.append("div")
			    .style("width", function(d) {
			    	return 15 + "px";
			    })
			    .text(function(d) { return d; });

		var parser, xmlDoc;

		setInterval(function(){
	    $.ajax({ url: "https://mosc.nicholas-fong.com/api/v1/stats", success: function(data){

	    	parser = new DOMParser();
				xmlDoc = parser.parseFromString(data,"text/xml");

				var received = xmlDoc.getElementsByTagName("received");
				var served = xmlDoc.getElementsByTagName("served");

				ecall_data[0] = received[0].childNodes[0].nodeValue;
				ecall_data[1] = served[0].childNodes[0].nodeValue;
				call_data[0] = received[1].childNodes[0].nodeValue;
				call_data[1] = served[1].childNodes[0].nodeValue;
				sms_data[0] = received[2].childNodes[0].nodeValue;
				sms_data[1] = served[2].childNodes[0].nodeValue;
				web_data[0] = received[3].childNodes[0].nodeValue;
				web_data[1] = served[3].childNodes[0].nodeValue;
        
	    }, dataType: "text"});

	    d3.select(".ecall-chart")
			  .selectAll("div")
			    .data(ecall_data)
			    .style("width", function(d) { 
			    	var sum = ecall_data[0] + ecall_data[1]; 
		    		return d / sum * 1100 + "px";
			    })
			  	.text(function(d) { return d; });

			d3.select(".call-chart")
			  .selectAll("div")
			    .data(call_data)
			    .style("width", function(d) { 
			    	var sum = call_data[0] + call_data[1]; 
		    		return d / sum * 1100 + "px";
			    })
			  	.text(function(d) { return d; });

			d3.select(".sms-chart")
			  .selectAll("div")
			    .data(sms_data)
			    .style("width", function(d) { 
			    	var sum = sms_data[0] + sms_data[1]; 
		    		return d / sum * 1100 + "px";
			    })
			  	.text(function(d) { return d; });

			d3.select(".web-chart")
			  .selectAll("div")
			    .data(web_data)
			    .style("width", function(d) { 
			    	var sum = web_data[0] + web_data[1]; 
		    		return d / sum * 1100 + "px";
			    })
			  	.text(function(d) { return d; });
			  	
		}, 5000);
	</script>
</html>